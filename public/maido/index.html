<html>
<!--
Interpreter API:
now: exact time when enter key is pressed. Does not update on reorder.
waiting: now plus one day. Updates on reorder.
d/m[/y] h:m[:/s][am|pm]: quick short date entry. 



-->


<!--
Sorting order:
dones....

then sort by time.


-->

<head>
    <script src="../jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Maido</title>
    <script src="maidocore.js"></script>
    <script src="support.js"></script>
    <script src="datesort.js"></script>
    <script src="loadsave.js"></script>
    <script src="search.js"></script>
    <script src="svg.min.js"></script>
    <script src="timeline.js"></script>
    <script>
        $(document).ready(() => {
            $("#todolist").on("input", ".initial input", (e) => {
                newNode = $(".initial")[0].cloneNode(true)
                newNode.classList.remove('initial');
                newNode.dataset.taskgroup = guid();
                $(newNode).find("*").each((i, e) => {
                    e.dataset.taskgroup = newNode.dataset.taskgroup
                })
                $("#todolist").append(newNode)
                $(newNode).find("." + e.currentTarget.classList[0]).focus()
                $(newNode).find("." + e.currentTarget.classList[0])[0].setSelectionRange(1, 1)
                $(".initial input").each((i, e) => {
                    e.value = ""
                })
            })

            $("body").on("keydown", (e) => {
                if (e.ctrlKey && e.key == "s") {
                    $('#savebtn').click()
                    return false
                }
            })

            $("#todolist").on("click", "tr:not(.initial) button.doneState", (e) => {
                if (e.currentTarget.innerHTML == "Redo") {
                    e.currentTarget.innerHTML = "Done"
                    $(e.currentTarget.parentElement.parentElement).find("button.postpone")[0].innerText =
                        "Postpone"
                } else {
                    e.currentTarget.innerHTML = "Redo"
                    $(e.currentTarget.parentElement.parentElement).find("button.postpone")[0].innerText =
                        "Remove"
                }
            })

            $("#todolist").on("click", "tr:not(.initial) button.postpone", (e) => {
                if (e.currentTarget.innerHTML == "Postpone") {
                    del = $(e.currentTarget.parentElement.parentElement).find(".date")[0];
                    dsplt = del.value.split(/\[/g);
                    dsplt[0] += "+1";
                    del.value = dsplt.join("[")
                    date_reparse(del)
                } else {
                    retract_description()
                    $(e.currentTarget.parentElement.parentElement).remove();
                }
            })

            $("#todolist").on("keypress", ".date", (e) => {
                if (e.currentTarget.parentElement.classList.contains("initial")) return;
                if (e.keyCode == 13) {
                    date_reparse(e.currentTarget);
                }
            })
            $("#todolist").on("focus", "tr", (e) => {
                // retract the previous textarea
                retract_description()
                if (!e.currentTarget.classList.contains("initial")) {
                    $(e.currentTarget).find("textarea")[0].style.display = "block";
                    $("#todolist_db").append($(e.currentTarget).find("textarea")[0])
                }
            })
            //autoload and shenanigans
            loadFromBrowser();
            first_sort();

        })

        function retract_description(ghost = false) {
            try {
                otg = $("#todolist_db").children("*")[0].dataset.taskgroup
                // remove previous copy
                $('td[data-role="ta_stor"][data-taskgroup=' + otg + '] textarea').remove();
                if (ghost) {
                    $('td[data-role="ta_stor"][data-taskgroup=' + otg + ']').append($("#todolist_db").children("*").clone())
                    $('td[data-role="ta_stor"][data-taskgroup=' + otg + ']').children().hide()
                } else {
                    $("#todolist_db").children("*")[0].style.display = "none"
                    $('td[data-role="ta_stor"][data-taskgroup=' + otg + ']').append($("#todolist_db").children("*"))
                }
                return otg;
            } catch (_e) {}
        }
    </script>
</head>

<body>
    <h1>Maido</h1>
    <ul>
        <li>
            <a>File</a>
            <div>
                <a onclick="saveToBrowser()">Save</a>
                <a onclick="loadFromBrowser()">Quickload</a>
                <a onclick="showLoader()">Load</a>
            </div>
        </li>
        <li>
            <a>Actions</a>
            <div>
                <a onclick="alignDates()">Toggle date alignment</a>
            </div>
        </li>
        <li>
            <a>View</a>
            <div>
                <a onclick="toggleTimeline()">Toggle timeline</a>
            </div>
        </li>
        <li>
            <a>Help</a>
            <div>
                <a onclick="showdocs()">Documentation</a>
            </div>
        </li>
    </ul>
    <div id="timeline_svg">

    </div>
    <div style="display:flex;flex-direction:row">
        <div>
            <span>Search: <input id="searchbar"></span>
            <table id="todolist">
                <tr class="initial">
                    <td><input class="name" placeholder="Task name"></td>
                    <td><input class="tags" placeholder="Tags"></td>
                    <td><input class="date" placeholder="Date"></td>
                    <td><button class="doneState">Done</button></td>
                    <td><button class="postpone">Postpone</button></td>
                    <td data-role="ta_stor"><textarea class="description" placeholder="Description..." style="display: none"></textarea></td>
                </tr>
            </table>
        </div>
        <div id="todolist_db">

        </div>
    </div>
    <div id="loader_dialog">
        <h2>Available save sessions:</h2>
        <div id="loader_dialog_panel_container">
            <div id="loader_dialog_list">
            </div>
            <div id="loader_dialog_viewer">

            </div>
        </div>
        <button onclick="$('#loader_dialog').hide()">Cancel</button>
    </div>
</body>

</html>